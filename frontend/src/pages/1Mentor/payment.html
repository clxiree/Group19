<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Payment</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

    <!-- Vue CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Axios CDN -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  
   <!-- Firebase JS SDK -->
   <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

  <!-- =======================================================
  * Template Name: Mentor
  * Template URL: https://bootstrapmade.com/mentor-free-education-bootstrap-theme/
  * Updated: Aug 07 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
  <script src="payment.js" defer></script>

</head>

<body class="course-details-page">

  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">

      <a href="index.html" class="logo d-flex align-items-center me-auto">
        
        <img src="assets/img/smootutor-logo.jpg">
        
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="tuteehomepage.html">Home<br></a></li>
          <li><a href="bookings.html">Bookings</a></li>
          
          <li class="dropdown">
            <a href="trainers.html" id="notesDropdown" aria-expanded="false">
              Tutors <i class="bi bi-chevron-down toggle-dropdown"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="notesDropdown">
              
              <li><a href="trainers.html" class="dropdown-item">All Tutors</a></li>
              <li><a href="tinder.html" class="dropdown-item">Find My Tutor</a></li>

            </ul>
          </li>
          <li><a href="chats.html">Chats</a></li>
          <li class="dropdown">
            <a href="notes.html" id="notesDropdown" aria-expanded="false">
              Notes <i class="bi bi-chevron-down toggle-dropdown"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="notesDropdown">
              
              <li><a href="notes.html?section=browse" class="dropdown-item">Browse Notes</a></li>
              <li><a href="notes.html?section=saved" class="dropdown-item">Saved Notes</a></li>

            </ul>
            <li><a href="contact.html">Contact</a></li>
          </li>
          
          
  
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>

      <a class="btn-getstarted"><div id="my-email"></div></a>

    </div>
  </header>

  <main class="main">

    <!-- Page Title -->
    <div class="page-title" data-aos="fade">
      <div class="heading">
        <div class="container">
          <div class="row d-flex justify-content-center text-center">
            <div class="col-lg-8">
              <h1>Payment</h1>
              <p class="mb-0">Please key in your payment details to proceed with the booking.</p>
            </div>
          </div>
        </div>
      </div>
      <nav class="breadcrumbs">
        <div class="container">
          <ol>
            <li><a href="index.html">Home</a></li>
            <li class="current">Payment</li>
          </ol>
        </div>
      </nav>
    </div><!-- End Page Title -->

    <section>
      <div class="container mt-5">
          <!-- Main Section -->
          <div class="row">
              <!-- Left Column -->
              <div class="col-md-8">
                  <!-- Section 1: Your Account -->
                  <div class="checkout-section p-4 mb-1 rounded" style="background-color: #f9f9f9; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                    <h5 class="section-title" style="font-weight: 600; color: #333;">1. Your Account</h5>
                    
                      <div id="user-email" style="font-weight: 500; color: #007bff;"></div>
                      <!-- <a href="#" style="color: #007bff; text-decoration: none; font-weight: 500; margin-left: 10px;">Edit</a> -->
                    </p>
                  </div>
  
                  <!-- Section 2: Payment & Discounts -->
                  <div class="checkout-section p-4 mb-4 rounded" style="background-color: #f9f9f9; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                      <h5 class="section-title mb-3" style="font-weight: 600; color: #333;">2. Payment & Discounts</h5>
                      
                      <!-- QR Code Placeholder -->
                      <div id="qr-code-container" style="text-align: center; margin-bottom: 10px;"></div>

                      <!-- <p style="font-weight: bold; color: #555;">Saved Payment Methods</p>
                      <div class="form-check mb-3">
                          <input class="form-check-input" type="radio" name="paymentMethod" id="visaCard" checked>
                          <label class="form-check-label" for="visaCard">
                              <img src="https://via.placeholder.com/40x20?text=VISA" alt="Visa" class="me-2"> **** 6408
                          </label>
                      </div>
                      <button class="btn btn-link text-decoration-none mt-2" style="color: #007bff;">More Payment Methods</button> -->
  
                      <!-- Discount Code Section -->
                      <div class="input-group mt-3">
                          <input type="text" class="form-control" placeholder="Discount Code" style="border-top-left-radius: 0.25rem; border-bottom-left-radius: 0.25rem;">
                          <button class="btn btn-secondary" id="apply-btn" type="button" style="border-top-right-radius: 0.25rem; border-bottom-right-radius: 0.25rem;">Apply</button>
                      </div>
  
                      <!-- Continue Button -->
                      <button id="continue-btn" class="btn btn-dark mt-3 w-100" style="background-color: #333; font-weight: 600; padding: 10px;">Click to Process Payment</button>
                  </div>
              </div>
  
              <!-- Right Column -->
              <div class="col-md-4">
                  <!-- Subscription Summary -->
                  <div class="checkout-section p-4 rounded" style="background-color: #f9f9f9; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                    <h5 class="section-title mb-3" style="font-weight: 600; color: #333;">Payment Summary</h5>
                    <p id="selected-tutor" style="color: #555;"></p>
                    <p id="selected-subject" style="color: #777;"></p>
                    <p id="selected-mode" style="color: #777;"></p>
                    <p id="booking-date" style="color: #777;"></p>
                    <p style="color: #777;">Payment by QR code</p>
                    <hr>
                    <p>Subtotal: <span class="float-end" style="color: #333;">SGD 0.00</span></p>
                    <p>Tax: <span class="float-end" style="color: #333;">SGD 0.00</span></p>
                    <hr>
                    <p><strong>Total: <span class="float-end total-amount" style="font-size: 1.25rem; color: #333;">SGD 0.00</span></strong></p>

                </div>
                
                      
  
                      <!-- Countdown Timer -->
                      <p class="text-center mt-4" style="font-weight: bold; color: #ff0000;">Time Remaining: <span id="countdown"></span></p>
                  </div>
              </div>
          </div>
      </div>
    </section>
    <!-- <section id="payment-section" class="container mt-5">
      <h2>Complete Your Payment</h2>
      <form id="payment-form">
          <button id="stripe-submit-button" class="btn btn-primary mt-4" type="submit">Pay</button>
      </form>
  </section> -->
  
  

  </main>

  <footer id="footer" class="footer position-relative light-background">

    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-4 col-md-6 footer-about">
          <a href="index.html" class="logo d-flex align-items-center">
            <span class="sitename">SMOOTutor</span>
          </a>
          <div class="footer-contact pt-3">
            <p>SMU</p>
            <p>81 Victoria St, Singapore 188065</p>
            <p class="mt-3"><strong>Phone:</strong> <span>+65 8111 9222</span></p>
            <p><strong>Email:</strong> <span>SMOOtutor@gmail.com</span></p>
          </div>
          <div class="social-links d-flex mt-4">
            <a href=""><i class="bi bi-twitter-x"></i></a>
            <a href=""><i class="bi bi-facebook"></i></a>
            <a href=""><i class="bi bi-instagram"></i></a>
            <a href=""><i class="bi bi-linkedin"></i></a>
          </div>
        </div>

        <div class="col-lg-2 col-md-3 footer-links">
          <h4>Useful Links</h4>
          <ul>
            <li><a href="#">Home</a></li>
            <li><a href="about.html">About us</a></li>
            <li><a href="#">Services</a></li>
            <li><a href="#">Terms of service</a></li>
            <li><a href="#">Privacy policy</a></li>
          </ul>
        </div>

        <div class="col-lg-2 col-md-3 footer-links">
          <h4>Our Services</h4>
          <ul>
            <li><a href="#">Find a Tutor</a></li>
            <li><a href="#">Find Quality Notes</a></li>
      
          </ul>
        </div>

        <div class="col-lg-4 col-md-12 footer-newsletter">
          <h4>Our Newsletter</h4>
          <p>Subscribe to our newsletter and receive the latest news about our products and services!</p>
          <form action="forms/newsletter.php" method="post" class="php-email-form">
            <div class="newsletter-form"><input type="email" name="email"><input type="submit" value="Subscribe"></div>
            <div class="loading">Loading</div>
            <div class="error-message"></div>
            <div class="sent-message">Your subscription request has been sent. Thank you!</div>
          </form>
        </div>

      </div>
    </div>

    <div class="container-fluid bg-light py-3">
      <div class="row">
        <div class="col-12 text-center">
          <p>© <strong class="sitename">SMOOTUTOR</strong> <span>All Rights Reserved</span></p>
          <div class="credits">
            <!-- Keep all links intact for free version -->
            Designed by SMOO students.
          </div>
        </div>
      </div>
    </div>

  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>
    <!-- Custom Toast Notification -->
  <div id="customToast" class="custom-toast">
    <span id="customToastMessage"></span>
    <button onclick="closeToast()" class="close-toast-btn">&times;</button>
  </div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>


  <script>
    const firebaseConfig = {
    apiKey: "AIzaSyDpmHo8Y79lMhABi1WuRaJ25ulV4JMdRGY",
    authDomain: "smootutor-ed94a.firebaseapp.com",
    databaseURL: "https://smootutor-ed94a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "smootutor-ed94a",
    storageBucket: "smootutor-ed94a.appspot.com",
    messagingSenderId: "289686522861",
    appId: "1:289686522861:web:5811385ced42106d78b5e4"
    };

    // Check if Firebase is already initialized to avoid errors
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            console.log("User is logged in with email:", user.email);
            document.getElementById("my-email").innerText = user.email;
            document.getElementById("user-email").innerText = user.email;
            // You can use user.email to retrieve user-specific data
        } else {
            console.log("No user is logged in.");
            // Redirect to login page if needed
            window.location.href = 'login.html';
        }
    });

    const storage = firebase.storage();
    // Function to start the 2-hour countdown

        // Function to show the toast with a message and type
        function showToast(message, type) {
        const toast = document.getElementById("customToast");
        const toastMessage = document.getElementById("customToastMessage");

        // Set the message and apply success/error style
        toastMessage.textContent = message;
        toast.classList.add("show", type);

        // Hide the toast after 3 seconds
        setTimeout(() => {
          toast.classList.remove("show", type);
        }, 5000);
      }

      // Close button function for the toast
      window.closeToast = function () {
        const toast = document.getElementById("customToast");
        toast.classList.remove("show");
      };

    function startCountdown() {
        const countdownElement = document.getElementById('countdown');

        // Get the current time and add 2 hours
        const now = new Date();
        const deadline = new Date(now.getTime() + 2 * 60 * 60 * 1000); // Add 2 hours

        // Update the countdown every second
        const countdownInterval = setInterval(function () {
            const currentTime = new Date();
            const timeRemaining = deadline - currentTime;

            // Calculate hours, minutes, and seconds
            const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
            const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);

            // Display the countdown timer
            countdownElement.innerHTML = `${hours}h ${minutes}m ${seconds}s`;

            // When the countdown reaches zero, stop the interval and display a message
            if (timeRemaining <= 0) {
                clearInterval(countdownInterval);
                countdownElement.innerHTML = "Time is up!";
            }
        }, 1000);
    }

    // Function to retrieve URL parameters
  function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
  }

  async function displayBookingDetails() {
    const date = getUrlParameter("date");
    const time = getUrlParameter("time");
    const tutorId = getUrlParameter("tutor"); // This will be the UserID
    const subject = getUrlParameter("subject");
    const mode = getUrlParameter("mode");
    const rate = parseFloat(getUrlParameter("rate")) || 0;

    // Fetch the tutor's name from Firebase Firestore based on the UserID (tutorId)
    try {
        const tutorDoc = await db.collection("Particulars").doc(tutorId).get();
        const tutorName = tutorDoc.exists ? tutorDoc.data().Name : "Unknown Tutor";

        // Insert data into the relevant HTML elements
        document.getElementById("booking-date").textContent = `Scheduled for: ${date} at ${time}`;
        document.getElementById("selected-tutor").textContent = `Tutor: ${tutorName}`;
        document.getElementById("selected-subject").textContent = `Subject: ${subject}`;
        document.getElementById("selected-mode").textContent = `Mode: ${mode}`;

        // Display rate and calculate subtotal and total
        document.querySelector(".float-end").textContent = `SGD ${rate.toFixed(2)}`;
        document.querySelector(".total-amount").textContent = `SGD ${rate.toFixed(2)}`;
    } catch (error) {
        console.error("Error fetching tutor's name:", error);
    }
}

    // Start the countdown when the page loads
    window.onload = startCountdown;

      // Firebase configuration setup (if not already included)
    const storageRef = firebase.storage().ref();

  // Function to display QR code
    function displayQRCode() {
        const qrCodeContainer = document.getElementById("qr-code-container"); // Placeholder div for QR code

        // Reference to the image in Firebase Storage
        const qrCodeRef = storageRef.child("payment/myqrcode.jpg");

        // Get the download URL
        qrCodeRef.getDownloadURL().then((url) => {
            // Create an img element and set its src to the URL
            const qrImage = document.createElement("img");
            qrImage.src = url;
            qrImage.alt = "QR Code for Payment";
            qrImage.style.width = "300px"; // Adjust size as needed
            qrImage.style.height = "300px";
            
            // Append the image to the container
            qrCodeContainer.appendChild(qrImage);
        }).catch((error) => {
            console.error("Error fetching QR code:", error);
        });
    }

    // Function to apply discount
    async function applyDiscount() {
    const discountInput = document.querySelector(".input-group input");
    const discountCode = discountInput.value.trim();
    const subtotalElement = document.querySelector(".float-end");
    const totalElement = document.querySelector(".total-amount");

    console.log("Entered Discount Code:", discountCode); // Log entered code

    try {
        // Retrieve discount code from Firebase
        const discountDoc = await db.collection("discount").doc("discount1").get();
        
        if (discountDoc.exists) {
            const validDiscountCode = discountDoc.data().discountcode1;
            console.log("Valid Discount Code from Firebase:", validDiscountCode); // Log the valid code

            if (discountCode === validDiscountCode) {
                const subtotal = parseFloat(subtotalElement.textContent.replace("SGD ", ""));
                const discountAmount = subtotal * 0.10;
                const discountedTotal = subtotal - discountAmount;

                subtotalElement.textContent = `SGD ${subtotal.toFixed(2)}`;
                totalElement.textContent = `SGD ${discountedTotal.toFixed(2)}`;
                showToast("Discount applied successfully!", "success");
            } else {
                showToast("Invalid discount code.", "error");
            }
        } else {
            console.error("Discount document not found in Firebase.");
            showToast("Discount document missing.", "error");
        }
    } catch (error) {
        console.error("Error applying discount:", error);
        showToast("An error occurred while applying the discount.", "error");
    }
}

document.getElementById("apply-btn").addEventListener("click", applyDiscount);



    // Call the function to display the QR code when the page loads
    document.addEventListener("DOMContentLoaded", () => {
      // Call existing functions to display booking details and QR code
      displayBookingDetails();
      displayQRCode();

      // Add event listener for the "Continue" button
      const continueBtn = document.getElementById("continue-btn");
      continueBtn.addEventListener("click", async () => {
          // Retrieve booking details from the URL or page content
          const subject = getUrlParameter("subject"); // Course code passed as subject in URL
          const tutorId = getUrlParameter("tutor"); // This should match the tutor's UserID
          const courseCode = document.getElementById("selected-subject").textContent.split(": ")[1];
          const mode = document.getElementById("selected-mode").textContent.split(": ")[1];
          const date = getUrlParameter("date");
          const time = getUrlParameter("time");
          const totalText = document.querySelector(".total-amount").textContent;
          const total = parseFloat(totalText.replace("SGD ", "").trim());

          // Retrieve and parse totalAmount from the displayed HTML element
          let totalAmount = 0;
          const totalAmountElement = document.querySelector(".total-amount");
          if (totalAmountElement) {
              totalAmount = parseFloat(totalAmountElement.textContent.replace("SGD ", "").trim());
          } else {
              console.error("Total amount element not found.");
              return;
          }

          try {
              // Retrieve course details from the Courses collection using the course code (subject)
              const courseQuery = await db.collection("Courses").where("Code", "==", subject).get();
              let courseData;
              if (!courseQuery.empty) {
                  courseData = courseQuery.docs[0].data();
              } else {
                  throw new Error("Course not found in database.");
              }
              
              // Fetch additional data from the Particulars collection
              const tutorDoc = await db.collection("Particulars").doc(tutorId).get();
              if (!tutorDoc.exists) {
                  throw new Error("Tutor details not found.");
              }
              const tutorData = tutorDoc.data();

              // Populate the data for the Bookings collection
            const bookingData = {
                bookingId: Math.floor(Math.random() * 100000), // Example booking ID, you may want a different logic
                tutorId: tutorData.UserID,
                tutorName: tutorData.Name,
                tutorImg: tutorData.Image,
                tutorReview: tutorData.Reviews || 0,
                tutorStars: tutorData.tutorStars || "⭐️⭐️⭐️",
                courseCode: courseData.Code,
                courseName: courseData.Name,
                dateOfLesson: date,
                time: time,
                mode: mode,
                fee: tutorData.Rate || total,
                totalAmount: totalAmount,
                status: "Pending", // Start as "Pending"
                tuteeId: 4 // Replace with the actual Tutee ID
            };

              // Add the booking to Firebase Bookings collection
            await db.collection("Bookings").add(bookingData);
            // Show success toast
            showToast("Payment is Successful!", "success");
          } catch (error) {
              console.error("Error saving payment information:", error);
              // Show error toast
              showToast("Failed to save payment information. Please try again.", "error");
          }
      });

      // Function to retrieve URL parameters
      function getUrlParameter(name) {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(name);
      }
  });

</script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>

</body>

</html>