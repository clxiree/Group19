<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>SMOOTutor Chats</title>
  <meta name="viewport">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts and Icons -->
  <link
    href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap"
    rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- Custom CSS -->
  <style>
    /* Improved CSS to make the page more modern and appealing */
    #no-chat-selected {
      display: none;
    }

    body.chats-page {
      background-color: #f8f9fa;
      margin: 0;
      color: #212529;
    }

    /* Chat Container */
    .chat-container {
      display: flex;
      height: calc(80vh - 70px);
    }

    /* Chat List */
    .chat-list {
      width: 25%;
      background-color: #ffffff;
      border-right: 1px solid #dee2e6;
      overflow-y: auto;
      position: relative;
    }

    .chat-list-header {
      padding: 15px;
      background-color: #ffffff;
      color: #212529;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #dee2e6;
    }

    .chat-list-header h4 {
      margin: 0;
      font-weight: 600;
      font-size: 1.1em;
    }

    .chat-list-header button {
      background: none;
      border: none;
      color: #212529;
      font-size: 1.5em;
      cursor: pointer;
    }

    .chat-list-header button:hover {
      color: #007bff;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 15px;
      cursor: pointer;
      transition: background 0.3s, box-shadow 0.3s;
    }

    .chat-item:hover {
      background-color: #e9ecef;
      box-shadow: inset 5px 0 0 #007bff;
    }

    .chat-item.active {
      background-color: #e9ecef;
      box-shadow: inset 5px 0 0 #007bff;
    }

    .chat-item img {
      border-radius: 50%;
      margin-right: 15px;
      width: 50px;
      height: 50px;
      object-fit: cover;
    }

    .chat-item-info {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .chat-item-name {
      font-weight: 600;
      color: #212529;
    }

    .chat-item-last-message {
      font-size: 0.9em;
      color: #6c757d;
      margin-top: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Chat Window */
    .chat-window {
      width: 75%;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
      position: relative;
    }

    /* No Chat Selected Placeholder */
    .no-chat-selected {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #f8f9fa;
      text-align: center;
      padding: 20px;
    }

    .no-chat-selected img {
      max-width: 60%;
      height: auto;
    }

    .no-chat-selected p {
      margin-top: 20px;
      color: #6c757d;
      font-size: 1.2em;
    }

    /* Chat Header */
    .chat-header {
      display: flex;
      align-items: center;
      padding: 15px;
      background-color: #ffffff;
      color: #212529;
      border-bottom: 1px solid #dee2e6;
    }

    .chat-header-info {
      display: flex;
      align-items: center;
      flex-grow: 1;
    }

    .chat-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
    }

    .chat-header .chat-status {
      font-size: 0.85em;
      color: #28a745;
    }

    .chat-header-actions button {
      background: none;
      border: none;
      margin-left: 10px;
      color: #212529;
      cursor: pointer;
      transition: color 0.3s;
    }

    .chat-header-actions button:hover {
      color: #007bff;
    }

    .chat-header-actions button i {
      font-size: 1.2em;
    }

    /* Message List */
    .message-list {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 20px;
      margin-bottom: 15px;
      font-size: 1em;
      position: relative;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.sent {
      align-self: flex-end;
      background-color: #d1e7dd;
      color: #0f5132;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .message.received {
      align-self: flex-start;
      background-color: #ffffff;
      color: #212529;
      border: 1px solid #dee2e6;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .message .timestamp {
      font-size: 0.8em;
      color: #adb5bd;
      position: absolute;
      bottom: -18px;
      right: 10px;
    }

    .message .delete-message {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      color: #adb5bd;
      cursor: pointer;
      font-size: 1em;
      display: none;
      transition: color 0.3s;
    }

    .message .delete-message:hover {
      color: #dc3545;
    }

    .message:hover .delete-message {
      display: block;
    }

    /* Message Input */
    .message-input-container {
      padding: 15px;
      background-color: #ffffff;
      border-top: 1px solid #dee2e6;
      display: flex;
      align-items: center;
    }

    .message-input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 30px;
      border: 1px solid #ced4da;
      outline: none;
      background-color: #ffffff;
      margin: 0 10px;
      color: #212529;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .message-input:focus {
      border-color: #80bdff;
      box-shadow: 0 0 5px rgba(128, 189, 255, 0.5);
    }

    .message-input-actions {
      background: none;
      border: none;
      font-size: 1.5em;
      color: #212529;
      cursor: pointer;
      transition: color 0.3s;
    }

    .message-input-actions:hover {
      color: #007bff;
    }

    /* Typing Indicator */
    .typing-indicator {
      padding: 5px 15px;
      font-size: 0.9em;
      color: #6c757d;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #ced4da;
      border-radius: 3px;
    }

    /* Responsive Design */
    @media (max-width: 767px) {
      .chat-container {
        flex-direction: column;
      }

      .chat-list {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #dee2e6;
      }

      .chat-window {
        width: 100%;
      }

      .chat-list-header h4 {
        font-size: 1em;
      }

      .chat-item-name {
        font-size: 1em;
      }

      .chat-item-last-message {
        font-size: 0.85em;
      }
    }

    .wrapper {
      position: fixed;
      bottom: 0;
      width: 100%;
      overflow: hidden;
      background: #2e3a90;
      /* padding: 10px 0; */
      z-index: 9999;
      transition: background-color 0.3s;
    }

    .boxes {
      overflow: hidden;
      background: #2e3a90;
    }

    .boxes-inner {
      display: flex;
      gap: 40px;
      /* Increased gap for better spacing */
    }

    .box {
      font-size: 20px;
      line-height: 50px;
      color: #fff;
      text-transform: uppercase;
      transition: color 0.3s, transform 0.3s;
      white-space: nowrap;
      cursor: pointer;
      /* Change cursor to pointer on hover */
    }

    .box:hover {
      color: #ffcc00;
      transform: scale(1.15);
    }

    .wrapper:hover {
      background-color: #2e3a90;
      /* Change background color on hover */
    }
  </style>
</head>

<body class="chats-page">

  <!-- Header -->
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
      <a href="index.html" class="logo d-flex align-items-center me-auto">
        <img src="assets/img/smootutor-logo.jpg" alt="SMOOTutor Logo">
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="tuteehomepage.html">Home</a></li>
          <li><a href="bookings.html">Bookings</a></li>

          <li class="dropdown">
            <a href="trainers.html" id="notesDropdown" aria-expanded="false">
              Tutors <i class="bi bi-chevron-down toggle-dropdown"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="notesDropdown">

              <li><a href="trainers.html" class="dropdown-item">All Tutors</a></li>
              <li><a href="tinder.html" class="dropdown-item">Find My Tutor</a></li>

            </ul>
          </li>
          <li><a href="chats.html">Chats</a></li>
          <li class="dropdown">
            <a href="notes.html" id="notesDropdown" aria-expanded="false">
              Notes <i class="bi bi-chevron-down toggle-dropdown"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="notesDropdown">

              <li><a href="notes.html?section=browse" class="dropdown-item">Browse Notes</a></li>
              <li><a href="notes.html?section=saved" class="dropdown-item">Saved Notes</a></li>

            </ul>

        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
      <a class="btn-getstarted">
        <div id="my-email"></div>
      </a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">

    <!-- Page Title -->
    <div class="page-title" data-aos="fade">
      <div class="heading">
        <div class="container">
          <div class="row d-flex justify-content-center text-center">
            <div class="col-lg-8">
              <h1>Chats</h1>
              <p class="mb-0">Chat with our helpful tutors to learn and grow stronger. Our tutors are
                always ready to help you with your studies.
              </p>
            </div>
          </div>
        </div>
      </div>

    </div><!-- End Page Title -->

    <div class="chat-container">
      <!-- Chat List -->
      <div class="chat-list" id="chat-list">
        <!-- Chat List Header -->
        <div class="chat-list-header">
          <h4>All Chats</h4>
          <button id="new-chat-button" title="Start a new chat"><i class="fas fa-plus"></i></button>
        </div>
        <!-- Chat items will be added here dynamically -->
      </div>

      <!-- Chat Window -->
      <div class="chat-window">


        <!-- Chat Header -->
        <div class="chat-header" id="chat-header" style="display: none;">
          <div class="chat-header-info">
            <img src="assets/img/default-avatar.png" alt="Chat Avatar" id="chat-avatar">
            <div>
              <span id="chat-name">Select a chat</span><br>
              <span class="chat-status" id="chat-status">Online</span>
            </div>
          </div>
          <div class="chat-header-actions">
            <button id="delete-chat-button" title="Delete Chat"><i class="fas fa-trash-alt"></i></button>
            <button title="Search in Chat"><i class="fas fa-search"></i></button>
            <button title="More Options"><i class="fas fa-ellipsis-v"></i></button>
          </div>
        </div>


        <!-- Placeholder for picture when no chat is selected -->
        <div class="no-chat-selected" id="no-chat-selected">
          <img src="assets/img/no-chat-selected.png" alt="No Chat Selected">
          <p>Select a chat to start messaging.</p>
        </div>

        <!-- Message List -->
        <div class="message-list" id="message-list"
          style="background-image: url('assets/img/background_chat.jpg'); background-size: cover; background-position: center;">
          <!-- Messages will appear here -->
        </div>

        <!-- Message Input -->
        <div class="message-input-container" id="message-input-container" style="display: none;">
          <button id="emoji-button" class="message-input-actions" title="Add Emoji"><i
              class="far fa-smile"></i></button>
          <input type="text" id="message-text" class="message-input" placeholder="Type a message..." disabled />
          <button id="attach-file-button" class="message-input-actions" title="Attach File"><i
              class="fas fa-paperclip"></i></button>
          <button id="send-message-button" class="message-input-actions" title="Send Message"><i
              class="fas fa-paper-plane"></i></button>
          <input type="file" id="attach-file-input" style="display: none;">
        </div>
        <div class="typing-indicator" id="typing-indicator" style="display: none;">Typing...</div>
      </div>
    </div>
  </main>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

  <!-- Emoji Picker Library -->
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>

  <!-- Firebase Initialization and Chat Logic -->
  <script>
    // Initialize Firebase
    var firebaseConfig = {
      // Your Firebase config here
      apiKey: "AIzaSyDpmHo8Y79lMhABi1WuRaJ25ulV4JMdRGY",
      authDomain: "smootutor-ed94a.firebaseapp.com",
      databaseURL: "https://smootutor-ed94a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smootutor-ed94a",
      storageBucket: "smootutor-ed94a.appspot.com",
      messagingSenderId: "289686522861",
      appId: "1:289686522861:web:5811385ced42106d78b5e4",
      measurementId: "G-46QED8ZFKJ"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    let currentUser = null;
    let selectedChatId = null;
    let messagesListener = null;

    // Authenticate and fetch chats
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUser = user; // Set the current user
        console.log("User is logged in with email:", user.email, "and UID:", user.uid);
        document.getElementById("my-email").innerText = user.email;
        fetchChats();
        // You can use user.email to retrieve user-specific data
      } else {
        console.log("No user is logged in.");
        // Redirect to login page if needed
        window.location.href = 'login.html';
      }
    });

    document.addEventListener("DOMContentLoaded", function() {
    setBackgroundFromFirebaseStorage();
  });

    // Function to set the background image from Firebase Storage
    function setBackgroundFromFirebaseStorage() {
      const backgroundPath = 'chats/chat_background.png'; // Replace with your image path in Firebase Storage
      const storage = firebase.storage();

      // Get the download URL from Firebase Storage
      storage.ref(backgroundPath).getDownloadURL()
      .then((url) => {
      // Set the background image of the message-list div
      const messageList = document.getElementById("message-list");
      messageList.style.backgroundImage = `url('${url}')`;
      })
      .catch((error) => {
        console.error("Error fetching background image from storage:", error);
        });
    }

    function fetchChats() {
  db.collection("Chats")
    .where("members", "array-contains", currentUser.email) // Filter chats where currentUser's email is a member
    .onSnapshot(snapshot => {
      const chatList = document.getElementById("chat-list");
      // Remove existing chat items except header
      chatList.querySelectorAll('.chat-item').forEach(item => item.remove());

      snapshot.forEach(doc => {
        const chatData = doc.data();
        const chatItem = document.createElement("div");
        chatItem.classList.add("chat-item", "d-flex", "align-items-center");
        chatItem.setAttribute('data-chat-id', doc.id); // Optional: for easier selection

        // Determine the recipient's email and fetch their avatar if not already stored
        const recipientEmail = chatData.members.find(email => email !== currentUser.email);
        let recipientName = "Chat"; // Default name
        let recipientAvatar = "assets/img/default-avatar.png"; // Default avatar

        // Fetch the recipient's details from the Users collection
        db.collection("Particulars").where("email", "==", recipientEmail).get()
          .then(userSnapshot => {
            if (!userSnapshot.empty) {
              const userData = userSnapshot.docs[0].data();
              recipientName = userData.Name || "Chat"; // Update with actual name
              const avatarFileName = userData.Image || "default.jpg"; // Image filename from Firestore

              // Get the download URL for the avatar image from Firebase Storage
              storage.ref(`images/team/${avatarFileName}`).getDownloadURL()
                .then(url => {
                  // Set the chat item's inner HTML with the dynamically fetched URL and recipient name
                  chatItem.innerHTML = `
                    <img src="${url}" alt="Avatar" class="rounded-circle me-2" width="50" height="50">
                    <div class="chat-item-info">
                      <div class="chat-item-name">${recipientName}</div>
                      <div class="chat-item-last-message">${chatData.last_message ? (chatData.last_message.type === 'text' ? truncateText(chatData.last_message.content, 30) : 'ðŸ“Ž Attachment') : ''}</div>
                    </div>
                  `;
                  chatList.appendChild(chatItem); // Add to chat list after setting innerHTML
                })
                .catch(error => {
                  console.error("Error fetching avatar URL:", error);
                  // Use default avatar if there's an error retrieving the image
                  chatItem.innerHTML = `
                    <img src="assets/img/default-avatar.png" alt="Avatar" class="rounded-circle me-2" width="50" height="50">
                    <div class="chat-item-info">
                      <div class="chat-item-name">${recipientName}</div>
                      <div class="chat-item-last-message">${chatData.last_message ? (chatData.last_message.type === 'text' ? truncateText(chatData.last_message.content, 30) : 'ðŸ“Ž Attachment') : ''}</div>
                    </div>
                  `;
                  chatList.appendChild(chatItem);
                });
            } else {
              // If no user data found, display default values
              chatItem.innerHTML = `
                <img src="assets/img/default-avatar.png" alt="Avatar" class="rounded-circle me-2" width="50" height="50">
                <div class="chat-item-info">
                  <div class="chat-item-name">${recipientName}</div>
                  <div class="chat-item-last-message">${chatData.last_message ? (chatData.last_message.type === 'text' ? truncateText(chatData.last_message.content, 30) : 'ðŸ“Ž Attachment') : ''}</div>
                </div>
              `;
              chatList.appendChild(chatItem);
            }

            // Attach click event to open the chat when clicked
            chatItem.addEventListener("click", () => selectChat(doc.id, chatItem, chatData));
          })
          .catch(error => {
            console.error("Error fetching user details:", error);
          });
      });
    }, error => {
      console.error("Error fetching chats:", error);
    });
}


    // Utility function to truncate text
    function truncateText(text, maxLength) {
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    function selectChat(chatId, chatItem, chatData) {
      selectedChatId = chatId;
      document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
      chatItem.classList.add('active');

      // Determine the recipient's email
      const recipientEmail = chatData.members.find(email => email !== currentUser.email);

      // Fetch recipient's details from Users collection
      db.collection("Particulars").where("email", "==", recipientEmail).get()
        .then(userSnapshot => {
          if (!userSnapshot.empty) {
            const userData = userSnapshot.docs[0].data();
            const recipientName = userData.Name || "Chat";
            const recipientAvatar = userData.Image || "assets/img/default-avatar.png";
            // console.log(recipientAvatar)

            // Update the chat header with recipient's name and avatar
            document.getElementById("chat-name").textContent = recipientName;
            document.getElementById("chat-avatar").src = recipientAvatar;
          } else {
            // Fallback if user data not found
            document.getElementById("chat-name").textContent = "Chat";
            document.getElementById("chat-avatar").src = "assets/img/default-avatar.png";
          }

          // Show chat header and message input
          document.getElementById("chat-header").style.display = "flex";
          document.getElementById("message-input-container").style.display = "flex";

          // Load chat messages
          loadChat(chatId);
          document.getElementById("message-text").disabled = false;
          document.getElementById("message-text").focus({ preventScroll: true });
          document.querySelector('.chat-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
          const chatContainer = document.querySelector('.chat-container');
          const yOffset = -2000; // Adjust this value as needed
          const yPosition = chatContainer.getBoundingClientRect().top + window.pageYOffset + yOffset;
          window.scrollTo({ top: yPosition, behavior: 'smooth' });
        })
        .catch(error => {
          console.error("Error fetching recipient's details:", error);

          // Fallback in case of error
          document.getElementById("chat-name").textContent = "Chat";
          document.getElementById("chat-avatar").src = "assets/img/default-avatar.png";

          // Show chat header and message input
          document.getElementById("chat-header").style.display = "flex";
          document.getElementById("message-input-container").style.display = "flex";

          // Load chat messages
          loadChat(chatId);
          document.getElementById("message-text").disabled = false;
          document.getElementById("message-text").focus({ preventScroll: true });
          document.querySelector('.chat-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
          const chatContainer = document.querySelector('.chat-container');
          const yOffset = -120; // Adjust this value as needed
          const yPosition = chatContainer.getBoundingClientRect().top + window.pageYOffset + yOffset;

          window.scrollTo({ top: yPosition, behavior: 'smooth' });
        });
    }


    // Load messages for the selected chat
    function loadChat(chatId) {
      if (messagesListener) {
        messagesListener(); // Detach previous listener
      }
      messagesListener = db.collection("Chats").doc(chatId).collection("messages")
        .orderBy("sent_at")
        .onSnapshot(snapshot => {
          const messageList = document.getElementById("message-list");
          messageList.innerHTML = ""; // Clear to prevent duplication
          snapshot.forEach(doc => {
            const messageData = doc.data();
            renderMessage(messageData, doc.id);
          });
          messageList.scrollTop = messageList.scrollHeight;
        }, error => {
          console.error("Error loading messages:", error);
        });
    }

    // Render a single message
    function renderMessage(messageData, messageId) {
      const messageList = document.getElementById("message-list");
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message");
      messageDiv.classList.add(messageData.sender_email === currentUser.email ? "sent" : "received");

      let messageContent = '';

      if (messageData.type === "text") {
        messageContent = escapeHTML(messageData.content);
      } else if (messageData.type === "file") {
        messageContent = `<a href="${messageData.content}" target="_blank">ðŸ“Ž File Attachment</a>`;
      }

      messageDiv.innerHTML = `
        ${messageContent}
        <div class="timestamp">${formatTimestamp(messageData.sent_at)} ${messageData.sender_email === currentUser.email ? (messageData.read_by_receiver ? '<i class="fas fa-check-double"></i>' : '<i class="fas fa-check"></i>') : ''}</div>
        <button class="delete-message" onclick="deleteMessage('${selectedChatId}', '${messageId}')"><i class="fas fa-trash-alt"></i></button>
      `;

      messageList.appendChild(messageDiv);
    }

    // Escape HTML to prevent XSS
    function escapeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Format timestamp
    function formatTimestamp(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate();
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Send a message
    document.getElementById("send-message-button").addEventListener("click", sendMessage);
    document.getElementById("message-text").addEventListener("keypress", event => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    function sendMessage() {
      const messageText = document.getElementById("message-text").value.trim();
      if (messageText && selectedChatId) {
        const messageRef = db.collection("Chats").doc(selectedChatId).collection("messages").doc();
        const messageData = {
          message_id: messageRef.id,
          content: messageText,
          sender_email: currentUser.email, // Use email instead of UID
          sent_at: firebase.firestore.FieldValue.serverTimestamp(),
          type: "text",
          read_by_receiver: false
        };

        messageRef.set(messageData).then(() => {
          document.getElementById("message-text").value = "";

          // Update last message in chat document
          db.collection("Chats").doc(selectedChatId).update({
            last_message: {
              ...messageData,
              sent_at: firebase.firestore.FieldValue.serverTimestamp()
            }
          });
        }).catch(error => {
          console.error("Error sending message:", error);
        });
      }
    }

    // Send a file
    document.getElementById("attach-file-button").addEventListener("click", () => {
      document.getElementById("attach-file-input").click();
    });

    document.getElementById("attach-file-input").addEventListener("change", event => {
      const file = event.target.files[0];
      if (file && selectedChatId) {
        const fileRef = storage.ref().child("chat_files/" + selectedChatId + "/" + file.name); // Organize files by chat
        const uploadTask = fileRef.put(file);

        uploadTask.on('state_changed',
          function (snapshot) {
            // Optional: Implement progress indicator
          },
          function (error) {
            console.error("Error uploading file:", error);
          },
          function () {
            uploadTask.snapshot.ref.getDownloadURL().then(function (downloadURL) {
              sendFileMessage(downloadURL);
            });
          }
        );
      }
    });

    function sendFileMessage(fileURL) {
      const messageRef = db.collection("Chats").doc(selectedChatId).collection("messages").doc();
      const messageData = {
        message_id: messageRef.id,
        content: fileURL,
        sender_email: currentUser.email, // Use email instead of UID
        sent_at: firebase.firestore.FieldValue.serverTimestamp(),
        type: "file",
        read_by_receiver: false
      };

      messageRef.set(messageData).then(() => {
        // Update last message in chat document
        db.collection("Chats").doc(selectedChatId).update({
          last_message: {
            ...messageData,
            sent_at: firebase.firestore.FieldValue.serverTimestamp()
          }
        });
      }).catch(error => {
        console.error("Error sending file message:", error);
      });
    }

    // Delete a message
    function deleteMessage(chatId, messageId) {
      if (confirm("Are you sure you want to delete this message?")) {
        db.collection("Chats").doc(chatId).collection("messages").doc(messageId).delete()
          .then(() => {
            console.log("Message deleted successfully.");
          })
          .catch(error => {
            console.error("Error deleting message:", error);
          });
      }
    }

    // Delete a chat
    document.getElementById("delete-chat-button").addEventListener("click", () => {
      if (selectedChatId && confirm("Are you sure you want to delete this chat?")) {
        db.collection("Chats").doc(selectedChatId).delete()
          .then(() => {
            console.log("Chat deleted successfully.");
            selectedChatId = null;
            document.getElementById("chat-header").style.display = "none";
            document.getElementById("message-input-container").style.display = "none";
            document.getElementById("no-chat-selected").style.display = "none";
            document.getElementById("message-list").innerHTML = "";
          })
          .catch(error => {
            console.error("Error deleting chat:", error);
          });
      }
    });

    // New Chat
    document.getElementById("new-chat-button").addEventListener("click", () => {
      const recipientEmail = prompt("Enter the email of the recipient:");
      if (recipientEmail) {
        if (recipientEmail === currentUser.email) {
          alert("You cannot start a chat with yourself.");
          return;
        }

        // Optional: Validate email format
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(recipientEmail)) {
          alert("Please enter a valid email address.");
          return;
        }

        // Check if recipient exists in Users collection
        db.collection("Particulars").where("email", "==", recipientEmail).get()
          .then(querySnapshot => {
            if (!querySnapshot.empty) {
              const recipientDoc = querySnapshot.docs[0];
              const recipientName = recipientDoc.data().name || "Chat";
              const recipientAvatar = recipientDoc.data().avatar || "assets/img/default-avatar.png";

              // Check if chat already exists between the two users
              db.collection("Chats")
                .where("members", "array-contains", currentUser.email)
                .get()
                .then(existingChats => {
                  let chatExists = false;
                  existingChats.forEach(chatDoc => {
                    const chatData = chatDoc.data();
                    if (chatData.members.includes(recipientEmail)) {
                      chatExists = true;
                      alert("Chat with this user already exists.");
                      // Optionally, select the existing chat
                      const existingChatItem = document.querySelector(`[data-chat-id="${chatDoc.id}"]`);
                      if (existingChatItem) {
                        selectChat(chatDoc.id, existingChatItem, chatData);
                      }
                    }
                  });

                  if (!chatExists) {
                    // Create a new chat
                    const chatRef = db.collection("Chats").doc();
                    const chatData = {
                      chat_id: chatRef.id,
                      chat_name: recipientName,
                      chat_avatar: recipientAvatar, // Set to recipient's avatar
                      members: [currentUser.email, recipientEmail], // Include both emails in the members array
                      last_message: null
                    };
                    chatRef.set(chatData).then(() => {
                      console.log("New chat created.");
                      // Optionally, select the newly created chat
                      selectChat(chatRef.id, null, chatData); // Adjust if necessary
                    }).catch(error => {
                      console.error("Error creating new chat:", error);
                    });
                  }
                })
                .catch(error => {
                  console.error("Error checking existing chats:", error);
                });
            } else {
              alert("No user found with that email.");
            }
          })
          .catch(error => {
            console.error("Error fetching user:", error);
          });
      }
    });

    // Emoji Picker
    const picker = new EmojiButton({
      position: 'top-start'
    });

    const trigger = document.getElementById('emoji-button');
    const messageInput = document.getElementById('message-text');

    picker.on('emoji', emoji => {
      messageInput.value += emoji;
      messageInput.focus();
    });

    trigger.addEventListener('click', () => {
      picker.togglePicker(trigger);
    });
  </script>

  <!-- Footer -->
  <footer id="footer" class="footer position-relative light-background">

    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-4 col-md-6 footer-about">
          <a href="index.html" class="logo d-flex align-items-center">
            <span class="sitename">SMOOTutor</span>
          </a>
          <div class="footer-contact pt-3">
            <p>SMU</p>
            <p>81 Victoria St, Singapore 188065</p>
            <p class="mt-3"><strong>Phone:</strong> <span>+65 8111 9222</span></p>
            <p><strong>Email:</strong> <span>SMOOtutor@gmail.com</span></p>
          </div>
          <div class="social-links d-flex mt-4">
            <a href=""><i class="bi bi-twitter-x"></i></a>
            <a href=""><i class="bi bi-facebook"></i></a>
            <a href=""><i class="bi bi-instagram"></i></a>
            <a href=""><i class="bi bi-linkedin"></i></a>
          </div>
        </div>

        <div class="col-lg-2 col-md-3 footer-links">
          <h4>Useful Links</h4>
          <ul>
            <li><a href="#">Home</a></li>
            <li><a href="about.html">About us</a></li>
            <li><a href="#">Services</a></li>
            <li><a href="#">Terms of service</a></li>
            <li><a href="#">Privacy policy</a></li>
          </ul>
        </div>

        <div class="col-lg-2 col-md-3 footer-links">
          <h4>Our Services</h4>
          <ul>
            <li><a href="#">Find a Tutor</a></li>
            <li><a href="#">Find Quality Notes</a></li>

          </ul>
        </div>

        <div class="col-lg-4 col-md-12 footer-newsletter">
          <h4>Our Newsletter</h4>
          <p>Subscribe to our newsletter and receive the latest news about our products and services!</p>
          <form action="forms/newsletter.php" method="post" class="php-email-form">
            <div class="newsletter-form">
              <input type="email" name="email" required placeholder="Enter your email">
              <input type="submit" value="Subscribe">
            </div>
            <div class="loading">Loading</div>
            <div class="error-message"></div>
            <div class="sent-message">Your subscription request has been sent. Thank you!</div>
          </form>
        </div>

      </div>
    </div>

    <div class="container-fluid bg-light py-3">
      <div class="row">
        <div class="col-12 text-center">
          <p>Â© <strong class="sitename">SMOOTUTOR</strong> <span>All Rights Reserved</span></p>
          <div class="credits">
            <!-- Keep all links intact for free version -->
            Designed by SMOO students.
          </div>
        </div>
      </div>
    </div>

  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>

</body>

</html>